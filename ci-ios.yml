# ============================================================
# CI/CD Pipeline - iOS App
# ============================================================
# Usage: Copier ce fichier dans .github/workflows/ de ton projet
# Secrets requis:
#   - APPLE_CERTIFICATE_BASE64 : Certificat de distribution (.p12) en base64
#   - APPLE_CERTIFICATE_PASSWORD : Mot de passe du certificat
#   - APPLE_PROVISIONING_PROFILE_BASE64 : Provisioning profile en base64
#   - KEYCHAIN_PASSWORD : Mot de passe temporaire pour le keychain
#   - APP_STORE_CONNECT_API_KEY_ID : API Key ID App Store Connect
#   - APP_STORE_CONNECT_ISSUER_ID : Issuer ID
#   - APP_STORE_CONNECT_API_KEY_BASE64 : ClÃ© API (.p8) en base64
# ============================================================

name: CI/CD iOS

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  SCHEME: "MyApp"              # â† Remplacer par ton scheme
  PROJECT: "MyApp.xcodeproj"   # â† ou WORKSPACE: "MyApp.xcworkspace"
  XCODE_VERSION: '15.4'

jobs:
  # ---- Ã‰TAPE 1 : Build & Tests ----
  test:
    name: ðŸ§ª Build & Tests
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache CocoaPods / SPM
        uses: actions/cache@v4
        with:
          path: |
            Pods
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-deps-${{ hashFiles('**/Podfile.lock', '**/Package.resolved') }}

      - name: Install dependencies
        run: |
          if [ -f "Podfile" ]; then
            pod install
          fi

      - name: Build & Test
        run: |
          xcodebuild clean test \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -resultBundlePath TestResults \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO | xcpretty

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults.xcresult

  # ---- Ã‰TAPE 2 : Build Archive & Upload TestFlight ----
  deploy-testflight:
    name: ðŸš€ Deploy TestFlight
    needs: test
    runs-on: macos-14
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Install dependencies
        run: |
          if [ -f "Podfile" ]; then
            pod install
          fi

      - name: Setup signing
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # CrÃ©er le keychain temporaire
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

          # Importer le certificat
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # Installer le provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode \
            > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Archive
        run: |
          xcodebuild archive \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -archivePath build/MyApp.xcarchive \
            -destination 'generic/platform=iOS'

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/MyApp.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/

      - name: Upload to TestFlight
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p ~/.private_keys
          echo "$API_KEY_BASE64" | base64 --decode \
            > ~/.private_keys/AuthKey_${API_KEY_ID}.p8

          xcrun altool --upload-app \
            --type ios \
            --file build/*.ipa \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID"

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain build.keychain

  # ---- Ã‰TAPE 3 : Notification ----
  notify:
    name: ðŸ“¢ Notification
    needs: deploy-testflight
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ DÃ©ploiement iOS" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${GITHUB_REF##*/}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${GITHUB_SHA::8}" >> $GITHUB_STEP_SUMMARY
          echo "- **TestFlight**: Upload terminÃ© âœ…" >> $GITHUB_STEP_SUMMARY
